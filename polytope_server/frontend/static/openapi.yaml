##
## Copyright 2022 European Centre for Medium-Range Weather Forecasts (ECMWF)
##
## Licensed under the Apache License, Version 2.0 (the "License");
## you may not use this file except in compliance with the License.
## You may obtain a copy of the License at
##
##     http://www.apache.org/licenses/LICENSE-2.0
##
## Unless required by applicable law or agreed to in writing, software
## distributed under the License is distributed on an "AS IS" BASIS,
## WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
## See the License for the specific language governing permissions and
## limitations under the License.
##
## In applying this licence, ECMWF does not waive the privileges and immunities
## granted to it by virtue of its status as an intergovernmental organisation nor
## does it submit to any jurisdiction.
##


openapi: 3.0.2
info:
  description: REST API for ECMWF data retrieval
  title: Polytope
  version: "1.0.0"
components:
  securitySchemes:
    basicAuth:
      scheme: basic
      type: http
    bearerAuth:
      scheme: bearer
      type: http
    ecmwfKey:
      description: Enter your ECMWF credentials as **EmailKey &lt;email&gt;&#58;&lt;apikey&gt;**
      in: header
      name: Authorization
      type: apiKey
  schemas:
    collections:
      type: array
      items:
        type: string
        enum:
          - collection1
    request:
      type: object
      properties:
        collection:
          example: collection1
          type: string
        content_length:
          example: "0"
          type: string
        id:
          example: "1"
          type: string
        log:
          example: an error message
          type: string
        md5:
          type: string
        status:
          example: queued
          type: string
        timestamp:
          example: "123"
          type: string
        url:
          example: http://localhost:32003/123
          type: string
        user_request:
          type: string
        username:
          example: admin
          type: string
        verb:
          example: retrieve
          type: string
    response:
      type: object
      properties:
        contentLength:
          type: integer
        contenttype:
          type: string
        location:
          type: string
        log:
          type: string
        status:
          type: string
        verb:
          type: string
    unauthenticated:
      type: object
      description: Missing authorization token or Key unrecognized. Please authenticate
      properties:
        message:
          type: string
          example: Missing authorization token. Please authenticate
    unauthorized:
      type: object
      description: Not authorized to access this resource
      properties:
        message:
          type: string
          example: Not authorized to access this resource
paths:
  /api/v1/auth/keys:
    post:
      description: Post user details to receive a key
      responses:
        '200':
          description: Key with expiry date
          content:
            application/json:
              schema:
                type: object
                properties:
                  expires:
                    type: string
                  key:
                    type: string
        '400':
          description: Missing authorization header
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    example: Missing authorization header
                    type: string
        '401':
          description: Missing authorization token or Key unrecognized. Please authenticate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthenticated'
      security:
        - basicAuth: []
  /api/v1/collections:
    get:
      description: Get collections
      responses:
        '200':
          description: List of collections
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      $ref: '#/components/schemas/collections'
        '400':
          description: No user information found for token
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    example: No user information found for token
                    type: string
        '401':
          description: Missing authorization token or Key unrecognized. Please authenticate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthenticated'
        '403':
          description: Not authorized to access this resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthorized'
  /api/v1/downloads/{request_id}:
    get:
      description: Download data
      parameters:
        - name: request_id
          in: path
          required: true
          description: The id of the request to download
          schema:
            type: string
      responses:
        '200':
          description: Data
          content:
            application/x-grib:
              schema:
                type: string
                format: binary
        '400':
          description: Request not ready for download yet
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    example: Request 123 not ready for download yet
                    type: string
        '401':
          description: Missing authorization token or Key unrecognized. Please authenticate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthenticated'
        '403':
          description: Not authorized to access this resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthorized'
  /api/v1/requests:
    get:
      description: Get user requests
      responses:
        '200':
          description: List of requests
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      $ref: '#/components/schemas/request'
        '401':
          description: Missing authorization token or Key unrecognized. Please authenticate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthenticated'
        '403':
          description: Not authorized to access this resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthorized'
  /api/v1/requests/{collection_or_request_id}:
    get:
      description: Get specific request or list of requests on collection
      parameters:
        - name: collection_or_request_id
          in: path
          required: true
          description: The id of the request or collection to retrieve
          schema:
            type: string
      responses:
        '200':
          description: List of collection requests OR data
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: array
                    items:
                      $ref: '#/components/schemas/request'
        '401':
          description: Missing authorization token or Key unrecognized. Please authenticate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthenticated'
        '403':
          description: Not authorized to access this resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthorized'
    delete:
      description: Delete specific request
      parameters:
        - name: collection_or_request_id
          in: path
          required: true
          description: The id of the request to delete
          schema:
            type: string
      responses:
        '200':
          description: Successfully deleted request
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Successfully deleted request
        '400':
          description: No user information found for token
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: No user information found for token
        '401':
          description: Missing authorization token or Key unrecognized. Please authenticate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthenticated'
        '403':
          description: Not authorized to access this resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/unauthorized'
  /api/v1/test:
    get:
      description: Test if the server is alive
      responses:
        '200':
          description: String saying server is alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    example: Polytope server is alive
                    type: string
tags:
  - name: Polytope
    description: REST API for ECMWF data retrieval
security:
  - bearerAuth: []
  - basicAuth: []
  - ecmwfKey: []
